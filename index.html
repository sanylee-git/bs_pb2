<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìƒí˜„ ë‹®ì€ê¼´ ì°¾ê¸° | ê·€ë©¸ì˜ ì¹¼ë‚ </title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <style>
    :root {
      --crimson: #c0392b;
      --deep-crimson: #7b1010;
      --gold: #f0c040;
      --gold-glow: #ffd700;
      --purple: #5c0a8a;
      --dark-bg: #05050f;
      --card-bg: rgba(10, 5, 25, 0.85);
      --border-glow: rgba(192, 57, 43, 0.6);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background-color: var(--dark-bg);
      font-family: 'Noto Sans KR', sans-serif;
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* â”€â”€ ë°°ê²½ íŒŒí‹°í´ ìº”ë²„ìŠ¤ â”€â”€ */
    #bg-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    /* â”€â”€ ë°°ê²½ ê·¸ë¼ë””ì–¸íŠ¸ â”€â”€ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 20% 50%, rgba(92, 10, 138, 0.18) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 20%, rgba(192, 57, 43, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 60% 80%, rgba(123, 16, 16, 0.12) 0%, transparent 50%);
      z-index: 0;
      pointer-events: none;
    }

    /* â”€â”€ ì „ì²´ ë ˆì´ì•„ì›ƒ â”€â”€ */
    .wrapper {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 16px 60px;
    }

    /* â”€â”€ í—¤ë” â”€â”€ */
    header {
      width: 100%;
      text-align: center;
      padding: 40px 20px 20px;
      position: relative;
    }

    .header-deco {
      font-family: 'Cinzel Decorative', cursive;
      font-size: clamp(10px, 2vw, 13px);
      letter-spacing: 6px;
      color: var(--gold);
      text-transform: uppercase;
      opacity: 0.8;
      margin-bottom: 12px;
      animation: fadeSlideDown 1s ease both;
    }

    .title-jp {
      font-size: clamp(28px, 6vw, 56px);
      font-weight: 900;
      line-height: 1;
      letter-spacing: 2px;
      background: linear-gradient(135deg, #ffffff 0%, var(--gold) 50%, var(--crimson) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 20px rgba(192,57,43,0.5));
      animation: fadeSlideDown 1s 0.1s ease both;
    }

    .title-sub {
      font-size: clamp(13px, 2.5vw, 18px);
      color: rgba(255,255,255,0.55);
      letter-spacing: 4px;
      margin-top: 8px;
      animation: fadeSlideDown 1s 0.2s ease both;
    }

    /* ìƒí˜„ ë±ƒì§€ */
    .badge-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 18px;
      flex-wrap: wrap;
      animation: fadeSlideDown 1s 0.3s ease both;
    }
    .badge {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid rgba(192,57,43,0.5);
      background: rgba(192,57,43,0.1);
      color: #ff8a80;
      letter-spacing: 2px;
    }

    /* êµ¬ë¶„ì„  */
    .divider {
      width: min(500px, 90%);
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--crimson), var(--gold), var(--crimson), transparent);
      margin: 28px auto;
      animation: fadeSlideDown 1s 0.35s ease both;
    }

    /* â”€â”€ ë©”ì¸ ì¹´ë“œ â”€â”€ */
    .main-card {
      background: var(--card-bg);
      border: 1px solid rgba(192,57,43,0.3);
      border-radius: 24px;
      padding: 32px 28px;
      width: min(520px, 100%);
      box-shadow:
        0 0 60px rgba(192,57,43,0.1),
        0 0 120px rgba(92,10,138,0.08),
        inset 0 1px 0 rgba(255,255,255,0.05);
      backdrop-filter: blur(20px);
      animation: fadeSlideUp 1s 0.4s ease both;
    }

    /* â”€â”€ ìŠ¤ìº” í”„ë ˆì„ â”€â”€ */
    .scan-frame {
      position: relative;
      width: 240px;
      height: 240px;
      margin: 0 auto 24px;
    }

    /* ì½”ë„ˆ ì¥ì‹ */
    .scan-frame::before,
    .scan-frame::after,
    .scan-inner::before,
    .scan-inner::after {
      content: '';
      position: absolute;
      width: 24px; height: 24px;
      border-color: var(--gold);
      border-style: solid;
    }
    .scan-frame::before { top:0; left:0; border-width: 3px 0 0 3px; border-radius: 4px 0 0 0; }
    .scan-frame::after  { top:0; right:0; border-width: 3px 3px 0 0; border-radius: 0 4px 0 0; }
    .scan-inner::before { bottom:0; left:0; border-width: 0 0 3px 3px; border-radius: 0 0 0 4px; }
    .scan-inner::after  { bottom:0; right:0; border-width: 0 3px 3px 0; border-radius: 0 0 4px 0; }
    .scan-inner {
      position: absolute;
      inset: 0;
    }

    /* íšŒì „í•˜ëŠ” ë§ */
    .ring {
      position: absolute;
      inset: -12px;
      border-radius: 50%;
      border: 1.5px solid transparent;
      border-top-color: var(--crimson);
      border-right-color: var(--gold);
      animation: spin 3s linear infinite;
      opacity: 0;
      transition: opacity 0.4s;
    }
    .ring-2 {
      inset: -20px;
      border-top-color: var(--purple);
      border-bottom-color: var(--crimson);
      animation: spin 5s linear infinite reverse;
    }
    .scanning .ring { opacity: 1; }

    /* ì›¹ìº  / ì´ë¯¸ì§€ í‘œì‹œ */
    #webcam-container {
      width: 220px;
      height: 220px;
      overflow: hidden;
      border-radius: 16px;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #webcam-container canvas,
    #webcam-container video,
    #preview-img {
      width: 220px;
      height: 220px;
      object-fit: cover;
      border-radius: 16px;
    }

    /* ë¹ˆ ìƒíƒœ ì•„ì´ì½˜ */
    .cam-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      color: rgba(255,255,255,0.3);
      font-size: 13px;
      text-align: center;
    }
    .cam-placeholder svg {
      width: 48px; height: 48px;
      opacity: 0.3;
    }

    /* ìŠ¤ìº” ë¼ì¸ */
    .scan-line {
      position: absolute;
      left: 8px; right: 8px;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--crimson), rgba(255,0,0,0.8), var(--crimson), transparent);
      top: 8px;
      animation: scanLine 2s ease-in-out infinite;
      opacity: 0;
      border-radius: 1px;
      box-shadow: 0 0 8px var(--crimson);
    }
    .scanning .scan-line { opacity: 1; }

    /* â”€â”€ íƒ­: ì¹´ë©”ë¼ / ì—…ë¡œë“œ â”€â”€ */
    .mode-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      padding: 4px;
    }
    .tab-btn {
      flex: 1;
      padding: 9px;
      border: none;
      border-radius: 9px;
      background: transparent;
      color: rgba(255,255,255,0.45);
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.25s;
      letter-spacing: 1px;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--deep-crimson), var(--purple));
      color: #fff;
      box-shadow: 0 2px 12px rgba(192,57,43,0.4);
    }

    /* â”€â”€ ë²„íŠ¼ë“¤ â”€â”€ */
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 22px;
    }

    .btn-main {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 2px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }
    .btn-main::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .btn-main:hover::before { opacity: 1; }
    .btn-main:active { transform: scale(0.97); }

    .btn-scan {
      background: linear-gradient(135deg, #8b0000 0%, #c0392b 50%, #8b0000 100%);
      background-size: 200% 100%;
      color: #fff;
      box-shadow: 0 4px 20px rgba(192,57,43,0.5);
      animation: shimmer 3s linear infinite;
    }
    .btn-scan:hover {
      box-shadow: 0 6px 28px rgba(192,57,43,0.7);
      transform: translateY(-1px);
    }
    .btn-scan:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      animation: none;
    }

    .btn-reset {
      background: rgba(255,255,255,0.07);
      color: rgba(255,255,255,0.6);
      border: 1px solid rgba(255,255,255,0.1);
      flex: 0 0 auto;
      padding: 14px 18px;
      font-size: 18px;
    }
    .btn-reset:hover { background: rgba(255,255,255,0.12); color: #fff; }

    /* íŒŒì¼ ì—…ë¡œë“œ */
    .upload-area {
      border: 2px dashed rgba(192,57,43,0.35);
      border-radius: 14px;
      padding: 28px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(192,57,43,0.04);
      display: none;
    }
    .upload-area.active-tab { display: block; }
    .upload-area:hover { border-color: var(--crimson); background: rgba(192,57,43,0.08); }
    .upload-area svg { width: 36px; height: 36px; color: var(--crimson); margin-bottom: 8px; }
    .upload-area p { font-size: 13px; color: rgba(255,255,255,0.5); }
    .upload-area p strong { color: var(--gold); }
    #file-input { display: none; }

    /* â”€â”€ ê²°ê³¼ ì„¹ì…˜ â”€â”€ */
    #result-section {
      width: min(520px, 100%);
      margin-top: 20px;
      display: none;
    }
    #result-section.show { display: block; animation: fadeSlideUp 0.6s ease both; }

    /* ìµœìƒìœ„ ê²°ê³¼ ì¹´ë“œ */
    .result-hero {
      background: var(--card-bg);
      border: 1px solid rgba(240,192,64,0.3);
      border-radius: 20px;
      padding: 28px;
      text-align: center;
      box-shadow:
        0 0 40px rgba(240,192,64,0.08),
        0 0 80px rgba(192,57,43,0.06);
      backdrop-filter: blur(20px);
      margin-bottom: 14px;
    }

    .result-label {
      font-size: 11px;
      letter-spacing: 4px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 8px;
      opacity: 0.8;
    }
    .result-name {
      font-size: clamp(28px, 7vw, 42px);
      font-weight: 900;
      background: linear-gradient(135deg, #fff 0%, var(--gold) 60%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 16px rgba(240,192,64,0.4));
      letter-spacing: 3px;
      margin-bottom: 4px;
    }
    .result-rank {
      font-size: 13px;
      color: var(--crimson);
      letter-spacing: 3px;
      margin-bottom: 20px;
    }
    .result-desc {
      font-size: 13px;
      color: rgba(255,255,255,0.55);
      line-height: 1.7;
      max-width: 320px;
      margin: 0 auto 20px;
    }
    .result-score-big {
      font-size: 52px;
      font-weight: 900;
      color: var(--gold);
      text-shadow: 0 0 30px rgba(240,192,64,0.5);
      line-height: 1;
    }
    .result-score-label {
      font-size: 11px;
      color: rgba(255,255,255,0.4);
      letter-spacing: 2px;
      margin-top: 4px;
    }

    /* ìƒí˜„ ëˆˆ ì¥ì‹ */
    .demon-eye {
      width: 60px;
      height: 60px;
      margin: 0 auto 16px;
      position: relative;
    }
    .demon-eye svg { width: 100%; height: 100%; }

    /* ëª¨ë“  ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ */
    .all-results {
      background: var(--card-bg);
      border: 1px solid rgba(192,57,43,0.2);
      border-radius: 20px;
      padding: 24px;
      backdrop-filter: blur(20px);
      box-shadow: 0 0 40px rgba(92,10,138,0.06);
    }
    .all-results h3 {
      font-size: 11px;
      letter-spacing: 4px;
      color: rgba(255,255,255,0.4);
      margin-bottom: 18px;
      text-transform: uppercase;
    }

    .pred-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }
    .pred-row:last-child { margin-bottom: 0; }

    .pred-name {
      font-size: 13px;
      font-weight: 700;
      min-width: 80px;
      color: rgba(255,255,255,0.85);
    }
    .pred-bar-wrap {
      flex: 1;
      height: 6px;
      background: rgba(255,255,255,0.07);
      border-radius: 3px;
      overflow: hidden;
    }
    .pred-bar {
      height: 100%;
      border-radius: 3px;
      transition: width 0.8s cubic-bezier(0.16,1,0.3,1);
      width: 0%;
    }
    .pred-bar.top {
      background: linear-gradient(90deg, var(--deep-crimson), var(--gold));
      box-shadow: 0 0 8px rgba(240,192,64,0.4);
    }
    .pred-bar.other {
      background: linear-gradient(90deg, rgba(92,10,138,0.8), rgba(192,57,43,0.6));
    }
    .pred-pct {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      min-width: 38px;
      text-align: right;
    }
    .pred-pct.top { color: var(--gold); font-weight: 700; }

    /* â”€â”€ ë¡œë”© â”€â”€ */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(5,5,15,0.85);
      border-radius: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .loading-overlay.show { opacity: 1; pointer-events: all; }

    .spinner {
      width: 40px; height: 40px;
      border: 3px solid rgba(192,57,43,0.2);
      border-top-color: var(--crimson);
      border-right-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .loading-text {
      font-size: 12px;
      letter-spacing: 3px;
      color: rgba(255,255,255,0.5);
    }

    /* â”€â”€ í‘¸í„° â”€â”€ */
    footer {
      text-align: center;
      margin-top: 50px;
      font-size: 11px;
      color: rgba(255,255,255,0.2);
      letter-spacing: 2px;
      line-height: 2;
    }

    /* â”€â”€ ì• ë‹ˆë©”ì´ì…˜ â”€â”€ */
    @keyframes fadeSlideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(24px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes scanLine {
      0%   { top: 8px; }
      50%  { top: calc(100% - 8px); }
      100% { top: 8px; }
    }
    @keyframes shimmer {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    @keyframes glitch {
      0%   { clip-path: polygon(0 2%, 100% 2%, 100% 5%, 0 5%); transform: translate(-3px); }
      25%  { clip-path: polygon(0 40%, 100% 40%, 100% 45%, 0 45%); transform: translate(3px); }
      50%  { clip-path: polygon(0 70%, 100% 70%, 100% 73%, 0 73%); transform: translate(-2px); }
      75%  { clip-path: polygon(0 88%, 100% 88%, 100% 91%, 0 91%); transform: translate(2px); }
      100% { clip-path: polygon(0 2%, 100% 2%, 100% 5%, 0 5%); transform: translate(0); }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 40px rgba(240,192,64,0.08), 0 0 80px rgba(192,57,43,0.06); }
      50%       { box-shadow: 0 0 60px rgba(240,192,64,0.18), 0 0 100px rgba(192,57,43,0.12); }
    }

    .result-hero { animation: pulse-glow 3s ease-in-out infinite; }

    /* â”€â”€ ë°˜ì‘í˜• â”€â”€ */
    @media (max-width: 400px) {
      .main-card { padding: 22px 16px; }
      .scan-frame { width: 200px; height: 200px; }
      #webcam-container { width: 180px; height: 180px; }
      #webcam-container canvas,
      #webcam-container video,
      #preview-img { width: 180px; height: 180px; }
    }
  </style>
</head>
<body>

  <!-- ë°°ê²½ íŒŒí‹°í´ -->
  <canvas id="bg-canvas"></canvas>

  <div class="wrapper">

    <!-- í—¤ë” -->
    <header>
      <div class="header-deco">Demon Slayer Â· Upper Moon</div>
      <h1 class="title-jp">é¬¼æ»…ã®åˆƒ<br>ìƒí˜„ ë‹®ì€ê¼´</h1>
      <p class="title-sub">ë‹¹ì‹ ì€ ì–´ë–¤ ìƒí˜„ì„ ë‹®ì•˜ì„ê¹Œ?</p>
      <div class="badge-row">
        <span class="badge">ìƒí˜„ å£±</span>
        <span class="badge">ìƒí˜„ å¼</span>
        <span class="badge">ìƒí˜„ å‚</span>
        <span class="badge">ìƒí˜„ è‚†</span>
        <span class="badge">ìƒí˜„ ä¼</span>
        <span class="badge">ìƒí˜„ é™¸</span>
      </div>
    </header>

    <div class="divider"></div>

    <!-- ë©”ì¸ ì¹´ë“œ -->
    <div class="main-card" style="position:relative;">

      <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
      <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <!-- íƒ­ -->
      <div class="mode-tabs">
        <button class="tab-btn active" id="tab-cam" onclick="switchTab('cam')">ğŸ“· ì¹´ë©”ë¼</button>
        <button class="tab-btn" id="tab-upload" onclick="switchTab('upload')">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
      </div>

      <!-- ìŠ¤ìº” í”„ë ˆì„ (ì¹´ë©”ë¼ íƒ­) -->
      <div class="scan-frame" id="scan-frame">
        <div class="scan-inner">
          <div class="ring"></div>
          <div class="ring ring-2"></div>
          <div class="scan-line"></div>
          <div id="webcam-container">
            <!-- ê¸°ë³¸ í”Œë ˆì´ìŠ¤í™€ë” -->
            <div class="cam-placeholder" id="cam-placeholder">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
              <span>ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ì„¸ìš”</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ì—…ë¡œë“œ ì˜ì—­ -->
      <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        <p><strong>í´ë¦­</strong>í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸ &amp; ë“œë¡­</p>
        <p style="margin-top:6px; font-size:11px;">JPG, PNG, WEBP ì§€ì›</p>
        <input type="file" id="file-input" accept="image/*" onchange="onFileSelect(event)">
        <!-- ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
        <img id="preview-img" style="display:none; margin-top:16px; border-radius:12px; max-height:200px; object-fit:cover;">
      </div>

      <!-- ë²„íŠ¼ ê·¸ë£¹ -->
      <div class="btn-group">
        <button class="btn-main btn-scan" id="start-btn" onclick="handleStart()" disabled>
          âš¡ ë¶„ì„ ì‹œì‘
        </button>
        <button class="btn-main btn-reset" title="ì´ˆê¸°í™”" onclick="resetAll()">â†º</button>
      </div>

      <!-- ìƒíƒœ ë©”ì‹œì§€ -->
      <p id="status-msg" style="text-align:center; font-size:12px; color:rgba(255,255,255,0.3); margin-top:12px; letter-spacing:1px; min-height:18px;">
        ëª¨ë¸ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...
      </p>
    </div>

    <!-- ê²°ê³¼ ì„¹ì…˜ -->
    <div id="result-section">

      <!-- ìµœìƒìœ„ ê²°ê³¼ -->
      <div class="result-hero">
        <div class="demon-eye">
          <!-- ìƒí˜„ì˜ ëˆˆ SVG ì•„ì´ì½˜ -->
          <svg viewBox="0 0 60 60" fill="none">
            <ellipse cx="30" cy="30" rx="28" ry="16" fill="rgba(192,57,43,0.15)" stroke="rgba(192,57,43,0.5)" stroke-width="1.5"/>
            <ellipse cx="30" cy="30" rx="12" ry="12" fill="#1a0010" stroke="rgba(192,57,43,0.8)" stroke-width="1"/>
            <ellipse cx="30" cy="30" rx="7" ry="7" fill="#c0392b" opacity="0.9"/>
            <ellipse cx="30" cy="30" rx="3.5" ry="3.5" fill="#0a0005"/>
            <ellipse cx="32" cy="28" rx="1.5" ry="1.5" fill="rgba(255,255,255,0.6)"/>
            <!-- ìƒí˜„ ë¬¸ì–‘ -->
            <text x="30" y="33" text-anchor="middle" font-size="5" fill="rgba(240,192,64,0.7)" font-family="serif">ä¸Šå¼¦</text>
          </svg>
        </div>
        <div class="result-label">ë‹¹ì‹ ê³¼ ë‹®ì€ ìƒí˜„</div>
        <div class="result-name" id="result-name">â€”</div>
        <div class="result-rank" id="result-rank"></div>
        <div class="result-desc" id="result-desc"></div>
        <div class="result-score-big" id="result-score">0%</div>
        <div class="result-score-label">ìœ ì‚¬ë„</div>
      </div>

      <!-- ì „ì²´ í™•ë¥  -->
      <div class="all-results">
        <h3>ì „ì²´ ë¶„ì„ ê²°ê³¼</h3>
        <div id="label-container"></div>
      </div>

    </div>

    <footer>
      DEMON SLAYER Â· UPPER MOON ANALYZER<br>
      ë³¸ ì„œë¹„ìŠ¤ëŠ” Teachable Machine AIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤<br>
      ê·€ë©¸ì˜ ì¹¼ë‚  Â© å¾å³ å‘¼ä¸–æ™´ / é›†è‹±ç¤¾
    </footer>

  </div>

  <script>
    // â”€â”€ ìºë¦­í„° ë°ì´í„°ë² ì´ìŠ¤ â”€â”€
    const CHARACTER_DB = {
      'ì½”ì¿ ì‹œë³´': { rank: 'ìƒí˜„ å£± (ì¼)', desc: 'ìµœê°•ì˜ ê·€ì‹ . ë‹¬ì˜ í˜¸í¡ì„ êµ¬ì‚¬í•˜ëŠ” ì. ì˜¤ë‹ˆê°€ì‹œë§ˆ ì‹œëŒ€ë¶€í„° ì‚´ì•„ë‚¨ì€ ì¡´ì¬ë¡œ, ì—¬ì„¯ ê°œì˜ ëˆˆì„ ê°€ì§„ ì ˆëŒ€ì.' },
      'ë„ìš°ë§ˆ':   { rank: 'ìƒí˜„ å¼ (ì´)', desc: 'ëƒ‰í˜¹í•œ ë¯¸ì†Œ ë’¤ì— ê°ì •ì´ ì—†ëŠ” í—ˆë¬´ì£¼ì˜ì. íŒ¬ì„ ì´ìš©í•œ ëƒ‰ê¸° ìˆ ì‹ì˜ ì‚¬ìš©ì. ì²œë¶€ì ì¸ ì•„ë¦„ë‹¤ì›€ì„ ì§€ë‹Œ ìƒí˜„.' },
      'ì•„ì¹´ì':   { rank: 'ìƒí˜„ å‚ (ì‚¼)', desc: 'ì í˜ˆê·€ìˆ  "íŒŒê´´ì‚´"ì˜ ë‹¬ì¸. ê°•ìì™€ì˜ ì „íˆ¬ë¥¼ ê°ˆë§í•˜ëŠ” ì „íˆ¬ ê·€ì‹ . ë¶ˆêµ´ì˜ ì˜ì§€ì™€ íŒŒê´´ì ì¸ ì „íˆ¬ë ¥ì˜ ì†Œìœ ì.' },
      'í•œí…êµ¬':   { rank: 'ìƒí˜„ è‚† (ì‚¬)', desc: 'ê°•í•œ ë¶€ì •ì  ê°ì •ì´ ë¶„ì—´ëœ ê·€ì‹ . ê·¹ë„ì˜ ê²ìŸì´ì§€ë§Œ ê·¸ ë‘ë ¤ì›€ì´ ê°•ë ¥í•œ ë¶„ì‹ ë“¤ì„ íƒ„ìƒì‹œí‚¤ëŠ” ì¡´ì¬.' },
      'êµì½”':     { rank: 'ìƒí˜„ ä¼ (ì˜¤)', desc: 'ê¸°ë¬˜í•œ í•­ì•„ë¦¬ ì†ì— ê±°ì£¼í•˜ëŠ” ê·€ì‹ . ê·¹ë„ë¡œ ë…íŠ¹í•œ ë¯¸ì  ê°ê°ì„ ìë‘í•˜ë©° ë¬¼ê³ ê¸° ì¡°ê°ì„ í†µí•œ ê³µê²©ì„ í¼ì¹œë‹¤.' },
      'ê·œíƒ€ë¡œ':   { rank: 'ìƒí˜„ é™¸ (ìœ¡) Â· ì˜¤ë¹ ', desc: 'ë‹¤í‚¤ì™€ í•¨ê»˜ ìœ¡ì²´ë¥¼ ê³µìœ í•˜ëŠ” ìƒí˜„. ë…ì´ ë‹´ê¸´ ë‚«ì„ íœ˜ë‘ë¥´ë©° ë…ê¸°ë¥¼ ë¿œì–´ë‚´ëŠ” ì”í˜¹í•œ ì „íˆ¬ì.' },
      'ë‹¤í‚¤':     { rank: 'ìƒí˜„ é™¸ (ìœ¡) Â· ì—¬ë™ìƒ', desc: 'ê·œíƒ€ë¡œì™€ í•¨ê»˜ ìœ¡ì²´ë¥¼ ê³µìœ í•˜ëŠ” ìƒí˜„. ì˜¤ë¹„ë¼ ë¶ˆë¦¬ëŠ” ëŒ€í˜• ë ë¥¼ ì´ìš©í•œ í˜„ë€í•œ ìˆ ì‹ì˜ ì‚¬ìš©ì.' },
    };

    function getCharInfo(className) {
      // ë¶€ë¶„ ì¼ì¹˜ ê²€ìƒ‰
      for (const [key, val] of Object.entries(CHARACTER_DB)) {
        if (className.includes(key) || key.includes(className)) {
          return { ...val, name: key };
        }
      }
      return { name: className, rank: 'ìƒí˜„ Â· Unknown', desc: 'ì•Œ ìˆ˜ ì—†ëŠ” ìƒí˜„ì˜ ê¸°ìš´ì´ ëŠê»´ì§‘ë‹ˆë‹¤...' };
    }

    // â”€â”€ TM ëª¨ë¸ â”€â”€
    const MODEL_URL = 'https://teachablemachine.withgoogle.com/models/crz4u0-De/';
    let model = null;
    let webcam = null;
    let isRunning = false;
    let currentTab = 'cam';
    let uploadedImage = null;

    // â”€â”€ ì´ˆê¸°í™” â”€â”€
    async function loadModel() {
      showLoading(true, 'ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      setStatus('AI ëª¨ë¸ì„ ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
      try {
        model = await tmImage.load(MODEL_URL + 'model.json', MODEL_URL + 'metadata.json');
        setStatus('âœ… ì¤€ë¹„ ì™„ë£Œ â€” ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');
        document.getElementById('start-btn').disabled = false;
        showLoading(false);
      } catch (e) {
        setStatus('âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
        showLoading(false);
        console.error(e);
      }
    }

    // â”€â”€ íƒ­ ì „í™˜ â”€â”€
    function switchTab(tab) {
      currentTab = tab;
      document.getElementById('tab-cam').classList.toggle('active', tab === 'cam');
      document.getElementById('tab-upload').classList.toggle('active', tab === 'upload');

      const scanFrame = document.getElementById('scan-frame');
      const uploadArea = document.getElementById('upload-area');
      scanFrame.style.display = tab === 'cam' ? 'block' : 'none';
      uploadArea.classList.toggle('active-tab', tab === 'upload');

      resetAll(false);
    }

    // â”€â”€ ì‹œì‘ ë²„íŠ¼ â”€â”€
    async function handleStart() {
      if (!model) return;
      if (currentTab === 'cam') {
        await startWebcam();
      } else {
        await analyzeUploadedImage();
      }
    }

    // â”€â”€ ì›¹ìº  ì‹œì‘ â”€â”€
    async function startWebcam() {
      if (isRunning) {
        // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ìŠ¤ëƒ…ìƒ· ì°ê¸°
        await snapAndPredict();
        return;
      }
      try {
        setStatus('ì¹´ë©”ë¼ ì ‘ê·¼ ì¤‘...');
        const flip = true;
        webcam = new tmImage.Webcam(220, 220, flip);
        await webcam.setup();
        await webcam.play();

        // í”Œë ˆì´ìŠ¤í™€ë” ì œê±° í›„ ìº”ë²„ìŠ¤ ì‚½ì…
        const container = document.getElementById('webcam-container');
        document.getElementById('cam-placeholder')?.remove();
        container.appendChild(webcam.canvas);

        isRunning = true;
        setScanAnimation(true);
        document.getElementById('start-btn').textContent = 'ğŸ“¸ ìŠ¤ëƒ…ìƒ· ì°ê¸°';
        setStatus('ì‹¤ì‹œê°„ ë¶„ì„ ì¤‘... ì–¼êµ´ì„ ì¹´ë©”ë¼ì— ë§ì¶°ì£¼ì„¸ìš”');

        loop();
      } catch (e) {
        setStatus('âŒ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ì—…ë¡œë“œ íƒ­ì„ ì´ìš©í•´ì£¼ì„¸ìš”.');
        console.error(e);
      }
    }

    async function loop() {
      if (!isRunning) return;
      webcam.update();
      await predict(webcam.canvas);
      requestAnimationFrame(loop);
    }

    async function snapAndPredict() {
      setScanAnimation(false);
      isRunning = false;
      if (webcam) {
        webcam.stop();
        webcam = null;
      }
      document.getElementById('start-btn').textContent = 'âš¡ ë‹¤ì‹œ ì‹œì‘';
      setStatus('ë¶„ì„ ì™„ë£Œ!');
    }

    // â”€â”€ ì´ë¯¸ì§€ ì—…ë¡œë“œ â”€â”€
    function onFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        uploadedImage = new Image();
        uploadedImage.onload = () => {
          const prev = document.getElementById('preview-img');
          prev.src = ev.target.result;
          prev.style.display = 'block';
          setStatus('ì´ë¯¸ì§€ ì„ íƒ ì™„ë£Œ â€” ë¶„ì„ ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”');
        };
        uploadedImage.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    const uploadArea = document.getElementById('upload-area');
    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.style.borderColor = 'var(--gold)'; });
    uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = ''; });
    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.style.borderColor = '';
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        const fakeEvent = { target: { files: [file] } };
        onFileSelect(fakeEvent);
      }
    });

    async function analyzeUploadedImage() {
      if (!uploadedImage) {
        setStatus('âš ï¸ ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
      }
      setScanAnimation(true);
      await predict(uploadedImage);
      setScanAnimation(false);
    }

    // â”€â”€ ì˜ˆì¸¡ â”€â”€
    async function predict(imageEl) {
      if (!model) return;
      const predictions = await model.predict(imageEl);

      // í™•ë¥  ë†’ì€ ìˆœ ì •ë ¬
      predictions.sort((a, b) => b.probability - a.probability);
      const top = predictions[0];
      const charInfo = getCharInfo(top.className);

      // ê²°ê³¼ íˆì–´ë¡œ ì—…ë°ì´íŠ¸
      document.getElementById('result-name').textContent = charInfo.name;
      document.getElementById('result-rank').textContent = charInfo.rank;
      document.getElementById('result-desc').textContent = charInfo.desc;

      const pct = Math.round(top.probability * 100);
      animateScore(pct);

      // ì „ì²´ ê²°ê³¼ ë°”
      renderAllPredictions(predictions);

      // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
      const sec = document.getElementById('result-section');
      sec.style.display = 'block';
      sec.classList.add('show');
    }

    function animateScore(target) {
      const el = document.getElementById('result-score');
      let cur = 0;
      const step = target / 40;
      const timer = setInterval(() => {
        cur = Math.min(cur + step, target);
        el.textContent = Math.round(cur) + '%';
        if (cur >= target) clearInterval(timer);
      }, 20);
    }

    function renderAllPredictions(predictions) {
      const container = document.getElementById('label-container');
      container.innerHTML = '';
      predictions.forEach((p, i) => {
        const pct = (p.probability * 100).toFixed(1);
        const row = document.createElement('div');
        row.className = 'pred-row';
        row.innerHTML = `
          <span class="pred-name">${p.className}</span>
          <div class="pred-bar-wrap">
            <div class="pred-bar ${i === 0 ? 'top' : 'other'}" data-pct="${p.probability * 100}"></div>
          </div>
          <span class="pred-pct ${i === 0 ? 'top' : ''}">${pct}%</span>
        `;
        container.appendChild(row);
      });
      // ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
      requestAnimationFrame(() => {
        document.querySelectorAll('.pred-bar').forEach(bar => {
          bar.style.width = bar.dataset.pct + '%';
        });
      });
    }

    // â”€â”€ ì´ˆê¸°í™” â”€â”€
    function resetAll(showMsg = true) {
      if (webcam) { try { webcam.stop(); } catch(e){} webcam = null; }
      isRunning = false;
      setScanAnimation(false);

      const container = document.getElementById('webcam-container');
      container.innerHTML = '';
      if (currentTab === 'cam') {
        container.innerHTML = `
          <div class="cam-placeholder" id="cam-placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            <span>ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ì„¸ìš”</span>
          </div>`;
      }

      // ì—…ë¡œë“œ ì´ˆê¸°í™”
      uploadedImage = null;
      const prev = document.getElementById('preview-img');
      prev.src = '';
      prev.style.display = 'none';
      document.getElementById('file-input').value = '';

      // ê²°ê³¼ ìˆ¨ê¸°ê¸°
      const sec = document.getElementById('result-section');
      sec.classList.remove('show');
      sec.style.display = 'none';
      document.getElementById('label-container').innerHTML = '';

      document.getElementById('start-btn').textContent = 'âš¡ ë¶„ì„ ì‹œì‘';
      if (showMsg) setStatus(model ? 'âœ… ì¤€ë¹„ ì™„ë£Œ â€” ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”' : 'ëª¨ë¸ ì¤€ë¹„ ì¤‘...');
    }

    // â”€â”€ ìœ í‹¸ â”€â”€
    function setStatus(msg) {
      document.getElementById('status-msg').textContent = msg;
    }
    function showLoading(show, msg = '') {
      const el = document.getElementById('loading-overlay');
      el.classList.toggle('show', show);
      if (msg) el.querySelector('.loading-text').textContent = msg;
    }
    function setScanAnimation(on) {
      document.getElementById('scan-frame').classList.toggle('scanning', on);
    }

    // â”€â”€ ë°°ê²½ íŒŒí‹°í´ â”€â”€
    (function initParticles() {
      const canvas = document.getElementById('bg-canvas');
      const ctx = canvas.getContext('2d');
      let W, H, particles = [];

      function resize() {
        W = canvas.width  = window.innerWidth;
        H = canvas.height = window.innerHeight;
      }
      resize();
      window.addEventListener('resize', resize);

      class Particle {
        constructor() { this.reset(true); }
        reset(init = false) {
          this.x = Math.random() * W;
          this.y = init ? Math.random() * H : H + 10;
          this.size = Math.random() * 2 + 0.5;
          this.speedY = -(Math.random() * 0.6 + 0.2);
          this.speedX = (Math.random() - 0.5) * 0.3;
          this.opacity = Math.random() * 0.5 + 0.1;
          this.color = Math.random() > 0.5
            ? `rgba(192,57,43,${this.opacity})`
            : `rgba(240,192,64,${this.opacity * 0.6})`;
        }
        update() {
          this.x += this.speedX;
          this.y += this.speedY;
          if (this.y < -10) this.reset();
        }
        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fillStyle = this.color;
          ctx.fill();
        }
      }

      for (let i = 0; i < 80; i++) particles.push(new Particle());

      (function animate() {
        ctx.clearRect(0, 0, W, H);
        particles.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(animate);
      })();
    })();

    // ê¸°ë³¸ìœ¼ë¡œ ì¹´ë©”ë¼ íƒ­ ë ˆì´ì•„ì›ƒ ì„¤ì •
    document.getElementById('scan-frame').style.display = 'block';

    // ëª¨ë¸ ë¡œë“œ
    loadModel();
  </script>
</body>
</html>
